<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Account - Trendora</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Remix Icon -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">

  <script src="auth.js" defer></script>

  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, Cantarell, sans-serif;
  color: #333; background-color: #f8f9fa; line-height: 1.6;
}

/* Header */
header { background: #fff; padding: 1rem 5%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
nav { display:flex; justify-content:space-between; align-items:center; max-width:1400px; margin:0 auto; gap:1rem; }
.logo { font-size:1.8rem; font-weight:700; color:#2c3e50; text-decoration:none; }
.nav-left { display:flex; align-items:center; gap:1rem; }
.back-home { background:#f3f4f6; border:none; padding:.45rem .75rem; border-radius:6px; cursor:pointer; text-decoration:none; color:#2c3e50; font-weight:600; }
.nav-links { display:flex; gap:2rem; list-style:none; }
.nav-links a { text-decoration:none; color:#555; font-weight:500; transition:color .25s; }
.nav-links a:hover, .nav-links a.active { color:#e74c3c; }
.nav-icons { display:flex; gap:1.5rem; align-items:center; position:relative; }
.nav-icons a { color:#555; font-size:1.2rem; text-decoration:none; position:relative; }
.cart-count { position:absolute; top:-8px; right:-8px; background:#e74c3c; color:#fff; font-size:.7rem; padding:2px 6px; border-radius:999px; min-width:18px; text-align:center; display:inline-block; }
.mobile-menu-btn { display:none; background:none; border:none; font-size:1.5rem; cursor:pointer; color:#555; }

/* Mobile menu */
.menu-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1999; }
.menu-overlay.active { display:block; }
.mobile-menu {
  position:fixed; top:0; left:-100%; width:80%; max-width:320px; height:100vh; background:#fff; box-shadow:2px 0 14px rgba(0,0,0,0.12);
  transition:left .28s ease; z-index:2000; padding:1.25rem;
}
.mobile-menu.active { left:0; }
.mobile-menu .close { position:absolute; top:.6rem; right:.6rem; background:none; border:none; font-size:1.4rem; cursor:pointer; }
.mobile-menu .mobile-links { margin-top:2.2rem; display:flex; flex-direction:column; gap:.6rem; }
.mobile-menu a { text-decoration:none; color:#333; padding:.75rem .6rem; border-radius:6px; display:block; }
.mobile-menu a:hover { background:#f3f4f6; }

/* Account Page */
.account-page { display:flex; gap:40px; padding:60px 5%; max-width:1400px; margin:0 auto; }
.sidebar { width:280px; flex-shrink:0; background:#fff; padding:2rem; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); height:fit-content; position:sticky; top:110px; }
.sidebar h1 { font-size:1.5rem; color:#2c3e50; margin-bottom:1.25rem; }
.sidebar-menu { list-style:none; }
.sidebar-menu li { margin-bottom:10px; }
.sidebar-menu button { width:100%; padding:12px 20px; text-align:left; border:none; background:#fff; cursor:pointer; border-radius:8px; font-size:15px; transition:all .2s; color:#555; display:flex; align-items:center; gap:10px; }
.sidebar-menu button.active { background:#2c3e50; color:#fff; }
.sidebar-menu button:hover:not(.active) { background:#f3f4f6; color:#2c3e50; }

.main-content { flex:1; background:#fff; padding:2.5rem; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }

.content-section { display:none; }
.content-section.active { display:block; animation:fadeIn .28s ease-in; }
@keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }

.content-section h2 { font-size:1.8rem; color:#2c3e50; margin-bottom:1.5rem; }

.form-row { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
.form-group { display:flex; flex-direction:column; }
.form-group.full-width { grid-column:1 / -1; }
.form-group label { margin-bottom:6px; font-weight:500; color:#2c3e50; }
.form-group input, .form-group textarea, .form-group select { padding:12px; border:1px solid #ddd; border-radius:6px; font-family:inherit; font-size:14px; }
.form-group textarea { min-height:100px; resize:vertical; }
.save-btn { background:#2c3e50; color:#fff; padding:12px 28px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:background .3s; }
.save-btn:hover { background:#1a252f; }

/* Empty State */
.empty-state { text-align:center; padding:3rem 1rem; }
.empty-state-icon { font-size:4rem; margin-bottom:1rem; }
.empty-state h3 { font-size:1.5rem; color:#2c3e50; margin-bottom:0.5rem; }
.empty-state p { color:#666; margin-bottom:1.5rem; }
.empty-state-btn { display:inline-block; background:#2c3e50; color:#fff; padding:12px 28px; border-radius:6px; text-decoration:none; font-weight:600; transition:background .3s; }
.empty-state-btn:hover { background:#1a252f; }

/* Toast notification */
.toast { position:fixed; bottom:30px; right:30px; background:#2c3e50; color:#fff; padding:16px 24px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:9999; animation:slideIn .3s ease; }
.toast.success { background:#27ae60; }
.toast.error { background:#e74c3c; }
@keyframes slideIn { from { transform:translateX(400px); opacity:0; } to { transform:translateX(0); opacity:1; } }

/* Footer */
footer {
  background: #2c3e50;
  color: white;
  padding: 4rem 5% 2rem;
}
.footer-content {
  max-width: 1400px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 3rem;
  margin-bottom: 3rem;
}
.footer-brand p {
  color: #bdc3c7;
  margin-top: 1rem;
  line-height: 1.8;
}
.footer-links h3 {
  margin-bottom: 1rem;
}
.footer-links ul {
  list-style: none;
}
.footer-links a {
  color: #bdc3c7;
  text-decoration: none;
  display: block;
  padding: 0.5rem 0;
  transition: color 0.3s;
}
.footer-links a:hover {
  color: white;
}
.social-icons {
  display: flex;
  gap: 1rem;
  margin-top: 1rem;
}
.social-icons a {
  color: white;
  font-size: 1.5rem;
}
.footer-bottom {
  max-width: 1400px;
  margin: 0 auto;
  padding-top: 2rem;
  border-top: 1px solid #34495e;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
  font-size: 0.9rem;
}
.footer-bottom a {
  color: #bdc3c7;
  text-decoration: none;
  margin: 0 0.5rem;
}
.footer-bottom a:hover {
  color: white;
}

/* Responsive Design */
@media (max-width: 968px) {
  .nav-links { display: none; }
  .mobile-menu-btn { display: block; }
  .account-page { flex-direction: column; padding: 40px 3%; }
  .sidebar { width: 100%; position: static; }
  .form-row { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
  header { padding: 1rem 3%; }
  .logo { font-size: 1.5rem; }
  .back-home { font-size: 0.9rem; padding: 0.4rem 0.6rem; }
  .main-content { padding: 1.5rem; }
  .footer-content { grid-template-columns: 1fr; gap: 2rem; }
  .footer-bottom { flex-direction: column; text-align: center; }
}

@media (max-width: 480px) {
  header { padding: 1rem 3%; }
  .logo { font-size: 1.4rem; }
  .nav-icons a { font-size: 1rem; }
  .main-content { padding: 1rem; }
  .content-section h2 { font-size: 1.5rem; }
  .toast { bottom: 20px; right: 20px; left: 20px; }
}
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="nav-left">
        <a href="index.html" class="logo">Trendora</a>
        <!-- Back to Home button visible on desktop/tablet -->
        <a href="index.html" class="back-home" id="backHomeDesktop">Back to Home</a>
      </div>

      <ul class="nav-links" role="navigation" aria-label="Primary">
        <li><a href="index.html">Home</a></li>
        <li><a href="shop.html">Shop</a></li>
        <li><a href="about.html">About Us</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>

      <div class="nav-icons" aria-hidden="false">
        <a href="search.html" title="Search">üîç</a>
        <a href="account.html" title="My Account" class="active">üë§</a>
        <a href="cart.html" title="Shopping Cart">üõí<span class="cart-count" id="cartCount" style="display:none">0</span></a>
      </div>

      <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Open menu">‚ò∞</button>
    </nav>
  </header>

  <!-- Mobile overlay + menu -->
  <div id="menuOverlay" class="menu-overlay" aria-hidden="true"></div>

  <aside id="mobileMenu" class="mobile-menu" aria-hidden="true" aria-label="Mobile menu">
    <button class="close" aria-label="Close menu" id="mobileMenuClose">‚úï</button>

    <nav class="mobile-links" aria-label="Mobile primary">
      <a href="index.html" id="backHomeMobile">‚Üê Back to Home</a>
      <a href="shop.html">Shop</a>
      <a href="about.html">About Us</a>
      <a href="contact.html">Contact</a>
      <a href="account.html" class="active">My Account</a>
      <a href="cart.html">Shopping Cart</a>
      <a href="signin.html">Sign In</a>
      <a href="signup.html">Sign up</a>
    </nav>
  </aside>

  <div class="account-page" id="accountPage">
    <aside class="sidebar" aria-label="Account sidebar">
      <h1>My Account</h1>
      <ul class="sidebar-menu" role="menu" aria-label="Account navigation">
        <li><button class="menu-btn active" data-section="profile" role="menuitem">üë§ Profile</button></li>
        <li><button class="menu-btn" data-section="orders" role="menuitem">üì¶ Orders</button></li>
        <li><button class="menu-btn" data-section="wishlist" role="menuitem">‚ù§Ô∏è Wishlist</button></li>
        <li><button class="menu-btn" data-section="settings" role="menuitem">‚öôÔ∏è Settings</button></li>
        <li><button class="menu-btn" id="signOutBtn" role="menuitem">üö™ Sign Out</button></li>
      </ul>
    </aside>

    <main class="main-content">
      <!-- Profile -->
      <section id="profile" class="content-section active" aria-labelledby="profileTitle">
        <h2 id="profileTitle">Profile Information</h2>
        <form id="profileForm">
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input id="firstName" name="firstName" type="text" value="Sarah" required>
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input id="lastName" name="lastName" type="text" value="Johnson" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" value="sarah.johnson@email.com" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone</label>
              <input id="phone" name="phone" type="tel" value="+1 555-123-4567">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="bio">Bio</label>
              <textarea id="bio" name="bio" placeholder="Tell us about yourself...">Style lover & coffee enthusiast.</textarea>
            </div>
          </div>

          <button class="save-btn" type="submit">Save Profile</button>
        </form>
      </section>

      <!-- Orders -->
      <section id="orders" class="content-section" aria-labelledby="ordersTitle">
        <h2 id="ordersTitle">Your Orders</h2>
        <div id="ordersList"></div>
        <div id="noOrders" class="empty-state" style="display:none">
          <div class="empty-state-icon">üì≠</div>
          <h3>No orders yet</h3>
          <p>Looks like you haven't placed any orders yet.</p>
          <a class="empty-state-btn" href="shop.html">Start Shopping</a>
        </div>
      </section>

      <!-- Wishlist -->
      <section id="wishlist" class="content-section" aria-labelledby="wishlistTitle">
        <h2 id="wishlistTitle">Your Wishlist</h2>
        <div id="wishlistGrid" class="wishlist-grid"></div>
        <div id="noWishlist" class="empty-state" style="display:none">
          <div class="empty-state-icon">üíî</div>
          <h3>Your wishlist is empty</h3>
          <p>Add items you love to save them for later.</p>
          <a class="empty-state-btn" href="shop.html">Browse Collections</a>
        </div>
      </section>

      <!-- Settings -->
      <section id="settings" class="content-section" aria-labelledby="settingsTitle">
        <h2 id="settingsTitle">Account Settings</h2>
        <form id="settingsForm">
          <div class="form-row">
            <div class="form-group">
              <label for="language">Language</label>
              <select id="language" name="language">
                <option value="en" selected>English</option>
                <option value="es">Espa√±ol</option>
                <option value="fr">Fran√ßais</option>
              </select>
            </div>
            <div class="form-group">
              <label for="currency">Currency</label>
              <select id="currency" name="currency">
                <option value="usd" selected>USD</option>
                <option value="eur">EUR</option>
                <option value="ngn">NGN</option>
              </select>
            </div>
          </div>

          <button class="save-btn" type="submit">Save Settings</button>
        </form>
      </section>
    </main>
  </div>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-brand">
        <div class="logo">Trendora</div>
        <p>Your choice, your style, your identity. Discover curated fashion trends that define who you are.</p>
      </div>

      <div class="footer-links">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="shop.html">Shop All</a></li>
          <li><a href="about.html">About Us</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="account.html">My Account</a></li>
        </ul>
      </div>

      <div class="footer-links">
        <h3>Customer Service</h3>
        <ul>
          <li><a href="shipping.html">Shipping Info</a></li>
          <li><a href="returns.html">Returns</a></li>
          <li><a href="size-guide.html">Size Guide</a></li>
          <li><a href="faq.html">FAQ</a></li>
        </ul>
      </div>

      <div>
        <h3>Connect With Us</h3>
        <div class="social-icons">
          <a href="#" aria-label="Facebook">üìò</a>
          <a href="#" aria-label="Instagram">üì∑</a>
          <a href="#" aria-label="Twitter">üê¶</a>
          <a href="#" aria-label="Pinterest">üìå</a>
        </div>
        <p style="color: #bdc3c7; margin-top: 1rem; font-size: 0.9rem;">Follow us for style inspiration and exclusive offers</p>
      </div>
    </div>

    <div class="footer-bottom">
      <div>¬© 2025 Trendora. All rights reserved.</div>
      <div>
        <a href="privacy.html">Privacy Policy</a>
        <a href="terms.html">Terms of Service</a>
      </div>
    </div>
  </footer>

  <div id="toast" class="toast" style="display:none"></div>

  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// ===== CONFIG: replace with your Supabase values =====
const SUPABASE_URL = "https://YOUR_PROJECT.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_PUBLIC_KEY";
// =====================================================
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// DOM refs
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const mobileMenu = document.getElementById('mobileMenu');
const mobileMenuClose = document.getElementById('mobileMenuClose');
const menuOverlay = document.getElementById('menuOverlay');
const sidebarButtons = Array.from(document.querySelectorAll('.sidebar-menu .menu-btn'));
const signOutBtn = document.getElementById('signOutBtn');
const ordersList = document.getElementById('ordersList');
const noOrders = document.getElementById('noOrders');
const wishlistGrid = document.getElementById('wishlistGrid');
const noWishlist = document.getElementById('noWishlist');
const settingsForm = document.getElementById('settingsForm');
const profileForm = document.getElementById('profileForm');
const cartCountEl = document.getElementById('cartCount');
const toastEl = document.getElementById('toast');

// Simple toast
function showToast(msg, type='success') {
  if (!toastEl) return;
  toastEl.textContent = msg;
  toastEl.className = `toast ${type} show`;
  setTimeout(()=> toastEl.classList.remove('show'), 3000);
}

// Mobile menu handlers
function openMobileMenu() {
  mobileMenu?.classList.add('active');
  menuOverlay?.classList.add('active');
  mobileMenu?.setAttribute('aria-hidden', 'false');
  menuOverlay?.setAttribute('aria-hidden', 'false');
}
function closeMobileMenu() {
  mobileMenu?.classList.remove('active');
  menuOverlay?.classList.remove('active');
  mobileMenu?.setAttribute('aria-hidden', 'true');
  menuOverlay?.setAttribute('aria-hidden', 'true');
}
mobileMenuBtn?.addEventListener('click', openMobileMenu);
mobileMenuClose?.addEventListener('click', closeMobileMenu);
menuOverlay?.addEventListener('click', closeMobileMenu);

// NAVBAR: set active link based on current page (index.html patterns)
document.querySelectorAll('nav .nav-links a').forEach(a => {
  try {
    if (a.getAttribute('href') === window.location.pathname.split('/').pop()) {
      a.classList.add('active');
    } else {
      a.classList.remove('active');
    }
  } catch(e){}
});

// Sidebar navigation: keyboard + click friendly
function activateSection(sectionId, buttonEl) {
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  const target = document.getElementById(sectionId);
  if (target) target.classList.add('active');
  sidebarButtons.forEach(b => b.classList.remove('active'));
  if (buttonEl) buttonEl.classList.add('active');
  // close mobile menu after navigation
  closeMobileMenu();
}

sidebarButtons.forEach(btn => {
  btn.addEventListener('click', (e) => {
    const sec = btn.dataset.section;
    activateSection(sec, btn);
  });
  btn.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      btn.click();
    }
  });
});

// Sign out
signOutBtn?.addEventListener('click', async (e) => {
  e.preventDefault();
  try {
    await supabase.auth.signOut();
    showToast('Signed out', 'success');
    setTimeout(()=> window.location.href = 'index.html', 700);
  } catch (err) {
    console.error('Sign out error', err);
    showToast('Sign out failed', 'error');
  }
});

// Ensure Orders/Wishlist/Settings are responsive even if empty
function renderEmptyStates() {
  if (ordersList && (!ordersList.innerHTML || ordersList.innerHTML.trim() === '')) {
    noOrders.style.display = 'block';
  } else {
    noOrders.style.display = 'none';
  }
  if (wishlistGrid && (!wishlistGrid.innerHTML || wishlistGrid.innerHTML.trim() === '')) {
    noWishlist.style.display = 'block';
  } else {
    noWishlist.style.display = 'none';
  }
}
renderEmptyStates();

// Load orders (called from init too)
async function loadOrders(userId) {
  if (!ordersList) return;
  ordersList.innerHTML = '<p>Loading orders...</p>';
  try {
    const { data, error } = await supabase
      .from('orders')
      .select('id, status, total, shipping, tax, created_at, order_items (id, product_name, unit_price, quantity)')
      .eq('customer_id', userId)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error fetching orders', error);
      ordersList.innerHTML = '<p class="muted">Unable to load orders.</p>';
      return;
    }
    if (!data || data.length === 0) {
      ordersList.innerHTML = '';
      noOrders.style.display = 'block';
      return;
    }
    noOrders.style.display = 'none';
    ordersList.innerHTML = data.map(order => {
      const items = (order.order_items || []).map(it => `<div style="display:flex;justify-content:space-between"><div>${escapeHtml(it.product_name)}</div><div>${it.quantity} √ó $${Number(it.unit_price).toFixed(2)}</div></div>`).join('');
      return `<div style="border:1px solid #eef2f6;border-radius:8px;padding:12px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between"><strong>Order #${escapeHtml(order.id)}</strong><small>${new Date(order.created_at).toLocaleString()}</small></div>
        <div style="margin-top:8px">${items}</div>
        <div style="display:flex;justify-content:space-between;margin-top:8px"><strong>Total: $${Number(order.total).toFixed(2)}</strong><small>${escapeHtml(order.status)}</small></div>
      </div>`;
    }).join('');
  } catch (err) {
    console.error('loadOrders exception', err);
    ordersList.innerHTML = '<p class="muted">Error loading orders.</p>';
  }
}

// Simple wishlist loader (adjust if you have wishlist table)
async function loadWishlist(userId) {
  if (!wishlistGrid) return;
  wishlistGrid.innerHTML = '<p>Loading wishlist...</p>';
  try {
    const { data, error } = await supabase
      .from('wishlist')
      .select('id, product_id, product_name, created_at')
      .eq('user_id', userId)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('wishlist fetch error', error);
      wishlistGrid.innerHTML = '<p class="muted">Unable to load wishlist.</p>';
      return;
    }
    if (!data || data.length === 0) {
      wishlistGrid.innerHTML = '';
      noWishlist.style.display = 'block';
      return;
    }
    noWishlist.style.display = 'none';
    wishlistGrid.innerHTML = data.map(item => `<div style="border:1px solid #eef2f6;padding:10px;border-radius:8px;margin-bottom:10px"><div>${escapeHtml(item.product_name || item.product_id)}</div></div>`).join('');
  } catch (err) {
    console.error('loadWishlist exception', err);
    wishlistGrid.innerHTML = '<p class="muted">Error loading wishlist.</p>';
  }
}

// Utility: escape HTML
function escapeHtml(unsafe) {
  if (unsafe === null || unsafe === undefined) return '';
  return String(unsafe).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

// Profile save handler (keeps same logic)
profileForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const firstName = document.getElementById('firstName').value.trim();
  const lastName = document.getElementById('lastName').value.trim();
  const email = document.getElementById('emailField').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const bio = document.getElementById('bio').value.trim();

  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user;
  if (!user) { showToast('Not signed in', 'error'); return; }

  const profile = { id: user.id, email, first_name: firstName, last_name: lastName, phone, bio };
  const { error } = await supabase.from('customers').upsert(profile, { onConflict: ['id'] });
  if (error) {
    console.error('profile upsert error', error);
    showToast('Failed to save profile', 'error');
  } else {
    showToast('Profile saved', 'success');
  }
});

// Settings save (same as before)
settingsForm?.addEventListener('submit', (e) => {
  e.preventDefault();
  const language = document.getElementById('language').value;
  const currency = document.getElementById('currency').value;
  localStorage.setItem('trendora_settings', JSON.stringify({ language, currency }));
  showToast('Settings saved', 'success');
});

// Update cart count
async function updateCartCount() {
  try {
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user;
    if (!user) { cartCountEl.style.display = 'none'; return; }
    const { data: items, error } = await supabase.from('cart').select('quantity').eq('user_id', user.id);
    if (error) { console.error('cart fetch error', error); cartCountEl.style.display='none'; return; }
    const total = (items || []).reduce((s, it) => s + (it.quantity || 1), 0);
    if (total > 0) {
      cartCountEl.textContent = total;
      cartCountEl.style.display = 'inline-block';
    } else cartCountEl.style.display = 'none';
  } catch (err) {
    console.error('updateCartCount err', err);
    cartCountEl.style.display = 'none';
  }
}

// Init: check session, load profile, orders, wishlist
(async function init() {
  try {
    const { data } = await supabase.auth.getSession();
    const session = data?.session;
    if (!session || !session.user) {
      // Not signed in -> redirect to signin
      window.location.href = 'signin.html';
      return;
    }
    const user = session.user;

    // Prefill profile fields from customers table or user metadata
    const { data: profile, error } = await supabase.from('customers').select('*').eq('id', user.id).single();
    if (!error && profile) {
      document.getElementById('firstName').value = profile.first_name || profile.full_name?.split(' ')[0] || '';
      document.getElementById('lastName').value = profile.last_name || (profile.full_name ? profile.full_name.split(' ').slice(1).join(' ') : '');
      document.getElementById('emailField').value = profile.email || user.email || '';
      document.getElementById('phone').value = profile.phone || '';
      document.getElementById('bio').value = profile.bio || '';
    } else {
      // fallback to auth metadata
      const metadata = user.user_metadata || {};
      document.getElementById('firstName').value = metadata.firstName || metadata.first_name || '';
      document.getElementById('lastName').value = metadata.lastName || metadata.last_name || '';
      document.getElementById('emailField').value = user.email || '';
      document.getElementById('phone').value = metadata.phone || '';
    }

    // Load orders and wishlist
    await loadOrders(user.id);
    await loadWishlist(user.id);
    await updateCartCount();

    // Bind keyboard navigation for sidebar
    document.querySelectorAll('.sidebar-menu .menu-btn').forEach((b, i, arr) => {
      b.setAttribute('tabindex', '0');
      b.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') { e.preventDefault(); const next = arr[(i+1)%arr.length]; next.focus(); }
        if (e.key === 'ArrowUp') { e.preventDefault(); const prev = arr[(i-1+arr.length)%arr.length]; prev.focus(); }
      });
    });

    // ensure initial active link highlights
    const activeBtn = document.querySelector('.sidebar-menu .menu-btn.active') || document.querySelector('.sidebar-menu .menu-btn');
    if (activeBtn) {
      activateSection(activeBtn.dataset.section, activeBtn);
    }

    // listen for auth changes to redirect when signed out
    supabase.auth.onAuthStateChange((event, sess) => {
      if (event === 'SIGNED_OUT') window.location.href = 'index.html';
    });

  } catch (err) {
    console.error('Init error', err);
    showToast('Initialization error', 'error');
  }
})();
</script>
</body>
</html>
